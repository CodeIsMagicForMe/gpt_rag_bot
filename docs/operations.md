# –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## –û–∫—Ä—É–∂–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏
- Terraform —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç—Ä–æ–π–∫–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏–π (`dev`, `stage`, `prod`). –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Yandex Lockbox —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç —Å –∫–ª—é—á–∞–º–∏ `ishosting_api_token`, `admin_ssh_keys`, `admin_totp_secret`, `bot_token`, `billing_database_url`, `provisioner_endpoint`, `telegram_bot_token`, `telegram_chat_id`.
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `environment` (—Å–º. `terraform/terraform.tfvars.example`) –∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ Ansible (`group_vars/all.yml` –∏–ª–∏ `-e environment=prod`).
- –†–æ–ª—å `secrets` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç Lockbox-—Å–µ–∫—Ä–µ—Ç –∏ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–ª–µ–π–±—É–∫–∞. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–µ–Ω `YC_TOKEN` –∏–ª–∏ `YC_SERVICE_ACCOUNT_KEY_FILE` —Å –ø—Ä–∞–≤–∞–º–∏ `lockbox.viewer`.

## –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∏ –ø–∞—Ç—á–∏
- SSH-–¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á–∞–º + TOTP (Google Authenticator). –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `deploy` Ansible —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Ñ–∞–π–ª `~/.google_authenticator`, –≤–∑—è—Ç—ã–π –∏–∑ Lockbox, –∏ –≤–∫–ª—é—á–∞–µ—Ç `AuthenticationMethods publickey,keyboard-interactive`.
- –ü–∞—Ä–æ–ª—å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞, Fail2ban –∏ UFW –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ –∑–∞—â–∏—Ç—É –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞, Unattended Upgrades –≤–∫–ª—é—á–µ–Ω—ã –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.
- –ü—Ä–∏ —É—Ç—Ä–∞—Ç–µ TOTP –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—É—é —Å–µ–∫—Ü–∏—é `admin_totp_secret` –≤ Lockbox –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≥–Ω–∞—Ç—å –ø–ª–µ–π–±—É–∫.

## –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π VPN
- Provisioner –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥–∏ –≤ Object Storage —Ç–æ–ª—å–∫–æ —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º (`AES256` –∏–ª–∏ KMS-–∫–ª—é—á –∏–∑ `S3_SSE_KMS_KEY_ID`).
- –í—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥–∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `generate_presigned_url` –∏ –¥–µ–π—Å—Ç–≤—É—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è (`S3_PRESIGN_TTL`).

## –ü–æ–ª–∏—Ç–∏–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ë–æ—Ç –ª–æ–≥–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è —Å–æ —Å–≤—è–∑–∫–æ–π `{tg_id, error_type, node, stars_tx_id}`. –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –∏–º–µ–Ω–∞ –∏ –¥—Ä—É–≥–∏–µ PII –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ª–æ–≥–∏.
- –î–ª—è –∞—É–¥–∏—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Ç–∏–∫–µ—Ç—ã –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ Telegram.

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ö–æ–º–∞–Ω–¥—ã `/terms` –∏ `/privacy`, –∞ —Ç–∞–∫–∂–µ –∫–Ω–æ–ø–∫–∏ ¬´üìÑ –£—Å–ª–æ–≤–∏—è¬ª –∏ ¬´üîê –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å¬ª –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã Terms of Service –∏ Privacy Policy.
- –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ–≥–æ Telegram ID –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ù–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Netdata —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º —ç–∫—Å–ø–æ—Ä—Ç–æ–º –º–µ—Ç—Ä–∏–∫ –¥–ª—è Prometheus –ø–æ –∞–¥—Ä–µ—Å—É `http://<node>:19999/netdata/api/v1/allmetrics?format=prometheus`. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¶–ü/–ø–∞–º—è—Ç–∏, –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ WireGuard (`go.d/wireguard`) –∏ OpenVPN (`python.d/openvpn`), –∞ —Ç–∞–∫–∂–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Ç–µ—Ä—å/RTT –∏–∑ `fping`.
- –°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–≤—ã—Ö —Ö–æ—Å—Ç–æ–≤ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è RTT –∑–∞–¥–∞—ë—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `netdata_latency_targets`. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Ç—Ä–µ–≤–æ–≥–∏ –Ω–∞ —Ä–æ—Å—Ç RTT –∏ –ø–æ—Ç–µ—Ä—é –ø–∞–∫–µ—Ç–æ–≤. –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ—Ä–æ–≥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ 120 –º—Å, –∫—Ä–∏—Ç–∏–∫–∞ –ø–æ—Å–ª–µ 250 –º—Å.
- Provisioner –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –≤ StatsD (`provisioner.provision.error`), Netdata –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏ —à–ª—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram —á–µ—Ä–µ–∑ `health_alarm_notify.conf`.

## VPN-—Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è
- –°–∫—Ä–∏–ø—Ç `/usr/local/bin/vpn-log-exporter.py` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è systemd-—Ç–∞–π–º–µ—Ä–æ–º `vpn-log-exporter.timer` –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç.
- –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ `/var/log/vpn/vpn-telemetry.log` –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –î–ª—è –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –≤—Å–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (–ø–∏—Ä—ã, –∞–¥—Ä–µ—Å–∞) —Ö—ç—à–∏—Ä—É—é—Ç—Å—è SHA-256 –∏ —É—Å–µ–∫–∞—é—Ç—Å—è –¥–æ 16 —Å–∏–º–≤–æ–ª–æ–≤.
- –ñ—É—Ä–Ω–∞–ª—ã —Ä–æ—Ç–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `/etc/logrotate.d/vpn-telemetry`.

## –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°–∫—Ä–∏–ø—Ç `/usr/local/bin/vpn-backup.sh` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è systemd-—Ç–∞–π–º–µ—Ä–æ–º `vpn-backup.timer` –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:30 UTC.
- –ë—ç–∫–∞–ø –≤–∫–ª—é—á–∞–µ—Ç:
  - `pg_dump` –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö `billing` –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ Docker (–ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ label `com.docker.compose.project=platform` –∏ —Å–µ—Ä–≤–∏—Å—É `db`).
  - –ê—Ä—Ö–∏–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (`/etc/wireguard`, `/etc/openvpn`, `/opt/amneziawg`, `/etc/smartdns`, `/opt/platform/docker-compose.yml`, `/opt/platform/.env`) –≤ `configs.tar.gz`.
  - –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É (`SHA256SUMS`).
- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ `/var/backups/vpn` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Object Storage —Å –ø–æ–º–æ—â—å—é `rclone` –≤ –±–∞–∫–µ—Ç `vpn-journald-backups` (–ø—É—Ç—å `<hostname>/<timestamp>`). –õ–æ–∫–∞–ª—å–Ω—ã–µ –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π —É–¥–∞–ª—è—é—Ç—Å—è.

### –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
```bash
sudo systemctl start vpn-backup.service
journalctl -u vpn-backup.service -b
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –¢–∞–π–º–µ—Ä `vpn-backup-restore.timer` –∑–∞–ø—É—Å–∫–∞–µ—Ç `/usr/local/bin/vpn-backup-restore.sh` –¥–≤–∞–∂–¥—ã –≤ –º–µ—Å—è—Ü (1-–≥–æ –∏ 15-–≥–æ —á–∏—Å–ª–∞ –≤ 04:00 UTC).
- –°–∫—Ä–∏–ø—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø, –ø–æ–¥–Ω–∏–º–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `postgres:15`, —Å–æ–∑–¥–∞—ë—Ç –±–∞–∑—É `billing_restore` –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç `pg_restore`. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–¥–∞–ª—è–µ—Ç—Å—è, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ `/var/log/vpn/vpn-backup-restore.log`.

### –¢–µ—Å—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é
```bash
sudo systemctl start vpn-backup-restore.service
journalctl -u vpn-backup-restore.service -b
```

## –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
1. –í—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π –∞—Ä—Ö–∏–≤ –≤ Object Storage: `backups:vpn-journald-backups/<hostname>/<timestamp>/`.
2. –°–∫–∞—á–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥: `rclone copy backups:vpn-journald-backups/<hostname>/<timestamp> /tmp/restore`.
3. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã: `sudo systemctl stop bot billing provisioner` –∏ `docker compose -p platform -f /opt/platform/docker-compose.yml stop`.
4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î:
   ```bash
   docker compose -p platform -f /opt/platform/docker-compose.yml exec -T db pg_restore -U billing -d billing --clean --create /tmp/billing.dump
   ```
   (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: `docker cp /tmp/restore/billing.dump $(docker ps --filter label=com.docker.compose.service=db --format "{{'{{'}}.ID{{'}}'}}"):/tmp/billing.dump`).
5. –†–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: `sudo tar -xzf /tmp/restore/configs.tar.gz -C /`.
6. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å: `sudo systemctl start bot billing provisioner` –∏ `systemctl status vpn-backup.service`.
