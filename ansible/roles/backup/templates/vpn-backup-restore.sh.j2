#!/usr/bin/env bash
set -euo pipefail

LOG_DIR=/var/log/vpn
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/vpn-backup-restore.log"

WORKDIR="{{ backup_local_dir }}"
LATEST=$(ls -1dt "$WORKDIR"/* 2>/dev/null | head -n1 || true)
if [[ -z "$LATEST" ]]; then
  echo "[$(date -u --iso-8601=seconds)] No backups available for restore validation" >>"$LOG_FILE"
  exit 0
fi

echo "[$(date -u --iso-8601=seconds)] Starting restore validation from $LATEST" >>"$LOG_FILE"

CONTAINER_NAME="vpn-restore-test-$(date +%s)"
if ! docker run -d --rm --name "$CONTAINER_NAME" -e POSTGRES_PASSWORD=test -v "$LATEST":/backup:ro postgres:15 >/dev/null; then
  echo "[$(date -u --iso-8601=seconds)] Failed to start temporary postgres container" >>"$LOG_FILE"
  exit 1
fi

cleanup() {
  docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1 || true
}
trap cleanup EXIT

END_TIME=$(( $(date +%s) + {{ backup_restore_timeout }} ))
while (( $(date +%s) < END_TIME )); do
  if docker exec "$CONTAINER_NAME" pg_isready -U postgres >/dev/null 2>&1; then
    break
  fi
  sleep 2
done

if ! docker exec "$CONTAINER_NAME" pg_isready -U postgres >/dev/null 2>&1; then
  echo "[$(date -u --iso-8601=seconds)] Temporary postgres container did not become ready" >>"$LOG_FILE"
  exit 1
fi

docker exec "$CONTAINER_NAME" createdb -U postgres billing_restore >/dev/null
if ! docker exec "$CONTAINER_NAME" pg_restore -U postgres -d billing_restore \
    "/backup/{{ backup_pg_database }}.dump" >/dev/null; then
  echo "[$(date -u --iso-8601=seconds)] Restore validation failed" >>"$LOG_FILE"
  exit 1
fi

echo "[$(date -u --iso-8601=seconds)] Restore validation succeeded" >>"$LOG_FILE"
