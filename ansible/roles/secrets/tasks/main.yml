---
- name: Resolve Lockbox secret id for environment
  ansible.builtin.set_fact:
    _lockbox_secret_id: "{{ yandex_lockbox_secret_ids[environment] | default('') }}"
  run_once: true

- name: Ensure Lockbox secret id is defined for environment
  ansible.builtin.assert:
    that:
      - _lockbox_secret_id | length > 0
    fail_msg: "Lockbox secret id is not set for environment '{{ environment }}'"
  run_once: true

- name: Fetch secrets from Yandex Lockbox
  community.yandex_cloud.lockbox_secret_info:
    secret_id: "{{ _lockbox_secret_id }}"
  register: _lockbox_info
  delegate_to: localhost
  run_once: true
  no_log: true

- name: Build secret dictionary
  ansible.builtin.set_fact:
    lockbox_secret_values: "{{ lockbox_secret_values | default({}) | combine({ item.key: item.text_value | default(item.binary_value | default('')) }) }}"
  loop: "{{ _lockbox_info.secret.entries | default([]) }}"
  delegate_to: localhost
  delegate_facts: true
  run_once: true
  no_log: true

- name: Share secrets with managed hosts
  ansible.builtin.set_fact:
    lockbox_secret_values: "{{ hostvars['localhost'].lockbox_secret_values | default({}) }}"
  when: hostvars.get('localhost') is defined and hostvars['localhost'].lockbox_secret_values is defined

- name: Override admin SSH keys from secrets if provided
  ansible.builtin.set_fact:
    admin_ssh_keys: "{{ lockbox_secret_values.admin_ssh_keys.split('\n') | reject('equalto', '') | list }}"
  when: lockbox_secret_values.admin_ssh_keys is defined and lockbox_secret_values.admin_ssh_keys | length > 0
  no_log: true

- name: Merge service environment variables from secrets
  ansible.builtin.set_fact:
    services_env: "{{ services_env | combine({
      'BOT_TOKEN': lockbox_secret_values.bot_token | default(services_env.BOT_TOKEN),
      'BILLING_DATABASE_URL': lockbox_secret_values.billing_database_url | default(services_env.BILLING_DATABASE_URL),
      'PROVISIONER_ENDPOINT': lockbox_secret_values.provisioner_endpoint | default(services_env.PROVISIONER_ENDPOINT),
      'TELEGRAM_BOT_TOKEN': lockbox_secret_values.telegram_bot_token | default(services_env.TELEGRAM_BOT_TOKEN),
      'TELEGRAM_CHAT_ID': lockbox_secret_values.telegram_chat_id | default(services_env.TELEGRAM_CHAT_ID)
    }) }}"
  when: lockbox_secret_values is defined
  no_log: true

- name: Ensure admin TOTP secret is present in Lockbox
  ansible.builtin.assert:
    that:
      - lockbox_secret_values.admin_totp_secret is defined
      - lockbox_secret_values.admin_totp_secret | length > 0
    fail_msg: "Lockbox secret must include admin_totp_secret to enforce SSH MFA"
  when: lockbox_secret_values is defined
  run_once: true
  no_log: true

- name: Expose admin TOTP secret if available
  ansible.builtin.set_fact:
    admin_totp_secret: "{{ lockbox_secret_values.admin_totp_secret }}"
  when: lockbox_secret_values.admin_totp_secret is defined and lockbox_secret_values.admin_totp_secret | length > 0
  no_log: true
